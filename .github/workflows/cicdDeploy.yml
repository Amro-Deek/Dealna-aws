name: Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # Checkout source
      # =========================
      - name: Checkout
        uses: actions/checkout@v4

      # =========================
      # Setup Go
      # =========================
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # =========================
      # Install tools
      # =========================
      - name: Install sqlc
        run: |
          go install github.com/sqlc-dev/sqlc/cmd/sqlc@v1.27.0
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install swag
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      # =========================
      # Build & generate artifacts
      # =========================
      - name: Build Linux binary
        working-directory: backend
        run: |
          make build-linux
          make swagger

      # =========================
      # Stop service on EC2
      # =========================
      - name: Stop service on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop dealna || true

      # =========================
      # Upload binary + swagger docs
      # =========================
      - name: Upload artifacts to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: |
            backend/dealna
            backend/docs
          target: "/opt/dealna"
          overwrite: true

      # =========================
      # Start service on EC2
      # =========================
      - name: Start service on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            chmod +x /opt/dealna/dealna
            sudo systemctl start dealna
            sudo systemctl status dealna --no-pager -l
