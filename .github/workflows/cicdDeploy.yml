name: Deploy Dealna Backend to EC2

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1Ô∏è‚É£ Checkout
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # 2Ô∏è‚É£ Setup Go
      # =========================
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # =========================
      # 3Ô∏è‚É£ Cache Go modules
      # =========================
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # =========================
      # 4Ô∏è‚É£ Install tools (sqlc + swag)
      # =========================
      - name: Install sqlc
        run: |
          go install github.com/sqlc-dev/sqlc/cmd/sqlc@v1.27.0
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install swag
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      # =========================
      # 5Ô∏è‚É£ Build backend (Swagger + Binary)
      # =========================
      - name: Build Linux binary
        working-directory: backend
        run: |
          make build-linux

      # =========================
      # 6Ô∏è‚É£ Debug build output (CRITICAL)
      # =========================
      - name: Debug built binary
        working-directory: backend
        run: |
          echo "== Built binary info =="
          ls -lh dealna
          file dealna
          sha256sum dealna

      # =========================
      # 7Ô∏è‚É£ Stop service on EC2
      # =========================
      - name: Stop Dealna service on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop dealna || true

      # =========================
      # 8Ô∏è‚É£ Remove old binary (HARD GUARANTEE)
      # =========================
      - name: Remove old binary on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p /opt/dealna
            sudo rm -f /opt/dealna/dealna
# =========================
# Setup SSH agent (REQUIRED)
# =========================
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

# =========================
# Upload new binary
# =========================
      - name: Upload new binary to EC2
        run: |
        scp -o StrictHostKeyChecking=no backend/dealna \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/dealna/dealna


      # =========================
      # üîü Fix permissions & restart
      # =========================
      - name: Start Dealna service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo chmod +x /opt/dealna/dealna
            sudo systemctl start dealna
            sudo systemctl status dealna --no-pager -l

      # =========================
      # 1Ô∏è‚É£1Ô∏è‚É£ Verify binary on EC2
      # =========================
      - name: Verify deployed binary
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "== EC2 binary info =="
            ls -lh /opt/dealna/dealna
            sha256sum /opt/dealna/dealna
